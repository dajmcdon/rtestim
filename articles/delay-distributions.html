<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="rtestim">
<title>Delay distributions • rtestim</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.11/clipboard.min.js" integrity="sha512-7O5pXpc0oCRrxk8RUfDYFgn0nO1t+jLuIOQdOMRp4APB7uZ4vSjspzp5y6YDtDs4VzUSTbWzBFZ/LKJhnyFOKw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Delay distributions">
<meta property="og:description" content="rtestim">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-dark navbar-expand-lg bg-primary" data-bs-theme="dark"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">rtestim</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.5</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/rtestim.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/delay-distributions.html">Delay distributions</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/dajmcdon/rtestim/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Delay distributions</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/dajmcdon/rtestim/blob/HEAD/vignettes/delay-distributions.Rmd" class="external-link"><code>vignettes/delay-distributions.Rmd</code></a></small>
      <div class="d-none name"><code>delay-distributions.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/dajmcdon/rtestim" class="external-link">rtestim</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://www.stats.ox.ac.uk/pub/MASS4/" class="external-link">nnet</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://forcats.tidyverse.org/" class="external-link">forcats</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org" class="external-link">tidyr</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme_get.html" class="external-link">theme_set</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>This package accommodates 3 different ways of specifying a delay
distribution in the renewal equation, and this vignette illustrates
these in turn. The renewal equation specifies that the expected
incidence at time <span class="math inline">\(t\)</span> is a weighted
sum of previous incidence, multiplied by <span class="math inline">\(R_t\)</span>: <span class="math display">\[\begin{equation}
\mathbb{E}[I_t \mid I_1,\ldots,I_{t-1}] = R_t \sum_{a=1}^t w_a I_{t-a},
\end{equation}\]</span> calculated by convolving the preceding <span class="math inline">\(a\)</span> days of new infections with the
discretized generation (or serial) interval distribution <span class="math inline">\(w\)</span> of length <span class="math inline">\(t\)</span>. It is the allowable distributions
<span class="math inline">\(\{w\}_{a=1}^n\)</span> that are the
focus.</p>
<div class="section level2">
<h2 id="discretization">Discretization<a class="anchor" aria-label="anchor" href="#discretization"></a>
</h2>
<p>First, it is important to recognize that the sequence <span class="math inline">\(\{w\}_{a=1}^n\)</span> is usually a discretization
of a probability density function, most frequently gamma or Weibull.
This is because observed incidence happens at discrete time points like
days or weeks, while time is continuous. Using the default (parametric)
delay distributions requires calculating a discrete approximation.</p>
</div>
<div class="section level2">
<h2 id="default-parametric-delay-distribution">Default (parametric) delay distribution<a class="anchor" aria-label="anchor" href="#default-parametric-delay-distribution"></a>
</h2>
<p>By default, <code><a href="../reference/estimate_rt.html">estimate_rt()</a></code> uses a gamma distribution
parameterized by the shape <span class="math inline">\(k\)</span> and
scale <span class="math inline">\(\theta\)</span>. This density has pdf
<span class="math display">\[
f_W(w) = \frac{1}{\Gamma(k)\theta^k} w^{k-1} e^{-w/\theta} I(w &gt; 0),
\]</span> where <span class="math inline">\(I\)</span> is the indicator
function. The mean of this distribution is <span class="math inline">\(k\theta\)</span>, and the variance is <span class="math inline">\(k\theta^2\)</span>. Both <span class="math inline">\(k\)</span> and <span class="math inline">\(\theta\)</span> must be greater than 0. The figure
below shows a few examples densities from this family.</p>
<p><img src="delay-distributions_files/figure-html/gamma-pdf-1.png" width="80%" style="display: block; margin: auto;"></p>
<p>The default is the orange curve shown above. Given an incidence
sequence of length <span class="math inline">\(n\)</span>, internally,
<code><a href="../reference/delay_calculator.html">delay_calculator()</a></code> creates <span class="math inline">\(\{w\}_{a=1}^n\)</span> by <span class="math display">\[
w_a = F(a) - F(a - 1),
\]</span> and then renormalizing with <code>w / sum(w)</code> to ensure
that it sums to 1. Here, <span class="math inline">\(F\)</span> is the
cumulative distribution function for Gamma (though similar works for any
continuous distribution). Note that this formula assumes that the
probability of a 0 delay is 0 and that the probability of a delay of
<span class="math inline">\(a\)</span> is really <span class="math display">\[
\int_{a-1}^a f_W(w) \, dw = F(a) - F(a-1).
\]</span></p>
<p>When using this default, the delay distribution is necessarily
assumed to be the same for all <span class="math inline">\(t\)</span>,
and we compute the convolution of <code>w</code> and <code>I</code> with
the Fast Fourier Transform. Finally, an adjustment is made to handle the
first observation. We define <span class="math inline">\(I_0 =
I_1\)</span>.</p>
<p>Just to illustrate this behaviour, we show the results for the
default setting on the included <code>cancovid</code> data.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">can_default</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/estimate_rt.html">estimate_rt</a></span><span class="op">(</span><span class="va">cancovid</span><span class="op">$</span><span class="va">incident_cases</span>, x <span class="op">=</span> <span class="va">cancovid</span><span class="op">$</span><span class="va">date</span>, nsol <span class="op">=</span> <span class="fl">20L</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">can_default</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_cartesian.html" class="external-link">coord_cartesian</a></span><span class="op">(</span>ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="delay-distributions_files/figure-html/can-default-1.png" width="80%" style="display: block; margin: auto;"></p>
</div>
<div class="section level2">
<h2 id="constant-non-parametric-delay-distribution">Constant, non-parametric delay distribution<a class="anchor" aria-label="anchor" href="#constant-non-parametric-delay-distribution"></a>
</h2>
<p>If we don’t believe that the Gamma distribution closely approximates
the serial interval distribution, then we can specify our own
distribution manually. For example, <a href="https://doi.org/10.2807/1560-7917.ES.2022.27.6.2200042" class="external-link">Backer et
al., Table S1</a> gives observed serial intervals for the Omicron (SGTF)
and Delta (non-SGTF) COVID-19 variants during 2 weeks in 2021 in the
Netherlands. For the sake of illustration, we aggregate these together
and use this as our (constant) delay distribution.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Data from Backer et al.</span></span>
<span><span class="va">delay</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span><span class="st">"backer.csv"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">delay</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">delay</span><span class="op">)</span></span>
<span><span class="va">delay</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">delay</span><span class="op">)</span></span>
<span><span class="va">delay</span> <span class="op">&lt;-</span> <span class="va">delay</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">delay</span><span class="op">)</span></span></code></pre></div>
<p><img src="delay-distributions_files/figure-html/cancov-nonpar-plot-1.png" width="80%" style="display: block; margin: auto;"></p>
<p>This distribution looks something like a gamma, but it has finite
support. We can easily use it instead.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">can_nonpar</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/estimate_rt.html">estimate_rt</a></span><span class="op">(</span></span>
<span>  <span class="va">cancovid</span><span class="op">$</span><span class="va">incident_cases</span>, </span>
<span>  x <span class="op">=</span> <span class="va">cancovid</span><span class="op">$</span><span class="va">date</span>, </span>
<span>  delay_distn <span class="op">=</span> <span class="va">delay</span>,</span>
<span>  nsol <span class="op">=</span> <span class="fl">20L</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">can_nonpar</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_cartesian.html" class="external-link">coord_cartesian</a></span><span class="op">(</span>ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="delay-distributions_files/figure-html/can-nonpar-1.png" width="80%" style="display: block; margin: auto;"></p>
<p>The result is much less dramatic than the previous version. This is
likely because the distribution is much more concentrated near short
delays. We can see this by examining the two CDFs.</p>
<p><img src="delay-distributions_files/figure-html/cdfs-1.png" width="80%" style="display: block; margin: auto;"></p>
</div>
<div class="section level2">
<h2 id="time-varying-delays">Time-varying delays<a class="anchor" aria-label="anchor" href="#time-varying-delays"></a>
</h2>
<p>Finally, we also allow time-varying delay distributions. This is
accomplished with a matrix. This requires a bit of work, but is not too
challenging. For example, to create the correct matrix using the Baker
et al. delays, the necessary code is the following.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># library(Matrix)</span></span>
<span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">cancovid</span><span class="op">)</span></span>
<span><span class="va">backer_delay</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">delay</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">n</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">delay</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">delay_mat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">n</span>, <span class="va">n</span><span class="op">)</span></span>
<span><span class="va">delay_mat</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">iter</span> <span class="kw">in</span> <span class="fl">2</span><span class="op">:</span><span class="va">n</span><span class="op">)</span> <span class="va">delay_mat</span><span class="op">[</span><span class="va">iter</span>, <span class="fl">1</span><span class="op">:</span><span class="va">iter</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rev.html" class="external-link">rev</a></span><span class="op">(</span><span class="va">backer_delay</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">iter</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">delay_mat</span> <span class="op">&lt;-</span> <span class="fu">drop0</span><span class="op">(</span><span class="fu">as</span><span class="op">(</span><span class="va">delay_mat</span>, <span class="st">"CsparseMatrix"</span><span class="op">)</span><span class="op">)</span> <span class="co"># make it sparse, not necessary</span></span>
<span><span class="va">delay_mat</span> <span class="op">&lt;-</span> <span class="va">delay_mat</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">delay_mat</span><span class="op">)</span> <span class="co"># renormalize</span></span></code></pre></div>
<p>We could then simply pass <code>delay_mat</code> to
<code>estimate_rt(..., delay_distn = delay_mat)</code>. The result would
be the same as that shown above.</p>
</div>
<div class="section level2">
<h2 id="variant-specific-delays">Variant-specific delays<a class="anchor" aria-label="anchor" href="#variant-specific-delays"></a>
</h2>
<p>For a more illustrative version of the previous example, we revisit
the Canadian data, but combine it with some additional information.</p>
<p>We use variant circulation information from <a href="https://covarr-net.github.io/duotang/duotang.html" class="external-link">CoVaRR-Net’s
Duotang notebook</a>.</p>
<p>We smooth the raw data using multinomial logistic regression on a
third order orthogonal polynomial to produce the following estimated
variant proportions in Canada.</p>
<pre><code><span><span class="co">#&gt; # weights:  75 (56 variable)</span></span>
<span><span class="co">#&gt; initial  value 576.814693 </span></span>
<span><span class="co">#&gt; iter  10 value 351.440027</span></span>
<span><span class="co">#&gt; iter  20 value 189.605996</span></span>
<span><span class="co">#&gt; iter  30 value 154.997884</span></span>
<span><span class="co">#&gt; iter  40 value 140.108374</span></span>
<span><span class="co">#&gt; iter  50 value 131.785853</span></span>
<span><span class="co">#&gt; iter  60 value 120.242371</span></span>
<span><span class="co">#&gt; iter  70 value 114.647448</span></span>
<span><span class="co">#&gt; iter  80 value 109.763514</span></span>
<span><span class="co">#&gt; iter  90 value 107.918644</span></span>
<span><span class="co">#&gt; iter 100 value 104.613062</span></span>
<span><span class="co">#&gt; final  value 104.613062 </span></span>
<span><span class="co">#&gt; stopped after 100 iterations</span></span></code></pre>
<p><img src="delay-distributions_files/figure-html/duotang-counts-1.png" width="80%" style="display: block; margin: auto;"></p>
<p>Using the estimated proportions, we label each date with the dominant
variant at the time (and restrict ourselves to the time period of the
included case data).</p>
<p><img src="delay-distributions_files/figure-html/unnamed-chunk-2-1.png" width="80%" style="display: block; margin: auto;"></p>
</div>
<div class="section level2">
<h2 id="creating-delay-distributions">Creating delay distributions<a class="anchor" aria-label="anchor" href="#creating-delay-distributions"></a>
</h2>
<p>We use the delay distribution data from the meta analysis in <a href="https://doi.org/10.1186/s12916-023-03070-8" class="external-link">Xu, X., Wu, Y.,
Kummer, A.G. et al.</a>. The raw data for their analysis is available on
<a href="https://github.com/xxyy0574/COVID-19-transmission-parameters" class="external-link">GitHub</a>.
We use a simple version of their procedure, taking the median
calculations across studies to find the mean and standard deviation of
the delay for each variant separately. Then we convert these to the
<span class="math inline">\(k\)</span> and <span class="math inline">\(\theta\)</span> parameters for the gamma
distribution.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data_raw</span> <span class="op">&lt;-</span> <span class="fu">readxl</span><span class="fu">::</span><span class="fu">read_excel</span><span class="op">(</span><span class="st">"xu-etal-DATA_RAW.xlsx"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">type</span>, <span class="va">para</span>, n <span class="op">=</span> <span class="va">Sample_size</span>, <span class="va">mean</span>, <span class="va">sd</span>, <span class="va">se</span>, <span class="va">median</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">type</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html" class="external-link">across</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">type</span>, <span class="va">para</span><span class="op">)</span>, <span class="va">as.numeric</span><span class="op">)</span><span class="op">)</span> </span>
<span></span>
<span><span class="va">bonehead_meta</span> <span class="op">&lt;-</span> <span class="va">data_raw</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">type</span>, <span class="va">para</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    no_n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/all.html" class="external-link">all</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    n <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span> <span class="op">~</span> <span class="va">n</span>, <span class="va">no_n</span> <span class="op">~</span> <span class="fl">1</span>, <span class="cn">TRUE</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html" class="external-link">median</a></span><span class="op">(</span><span class="va">n</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    mean <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">mean</span><span class="op">)</span> <span class="op">~</span> <span class="va">mean</span>, <span class="cn">TRUE</span> <span class="op">~</span> <span class="va">median</span><span class="op">)</span>,</span>
<span>    sd <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">sd</span><span class="op">)</span> <span class="op">~</span> <span class="va">sd</span>, <span class="cn">TRUE</span> <span class="op">~</span> <span class="va">se</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">type</span>, <span class="va">para</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span></span>
<span>    mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html" class="external-link">median</a></span><span class="op">(</span><span class="va">mean</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    sd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html" class="external-link">median</a></span><span class="op">(</span><span class="va">sd</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    .groups <span class="op">=</span> <span class="st">"drop"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="co">## There's only one Beta and only IP. </span></span>
<span><span class="co">## We use the corresponding sd for Alpha IP, </span></span>
<span><span class="co">## and duplicate Alpha for GT / ST</span></span>
<span></span>
<span><span class="va">Beta_IP</span> <span class="op">&lt;-</span> <span class="va">bonehead_meta</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">type</span> <span class="op">==</span> <span class="st">"Beta"</span><span class="op">)</span></span>
<span><span class="va">Beta_IP</span><span class="op">$</span><span class="va">sd</span> <span class="op">=</span> <span class="va">bonehead_meta</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">type</span> <span class="op">==</span> <span class="st">"Alpha"</span>, <span class="va">para</span> <span class="op">==</span> <span class="st">"IP"</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span><span class="va">sd</span><span class="op">)</span></span>
<span><span class="va">Beta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span></span>
<span>  <span class="va">Beta_IP</span>,</span>
<span>  <span class="va">bonehead_meta</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">type</span> <span class="op">==</span> <span class="st">"Alpha"</span>, <span class="va">para</span> <span class="op">!=</span> <span class="st">"IP"</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"Beta"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">delay_dstns_byvar</span> <span class="op">&lt;-</span> <span class="va">bonehead_meta</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">type</span> <span class="op">!=</span> <span class="st">"Beta"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">Beta</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">type</span>, <span class="va">para</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>shape <span class="op">=</span> <span class="va">mean</span><span class="op">^</span><span class="fl">2</span> <span class="op">/</span> <span class="va">sd</span><span class="op">^</span><span class="fl">2</span>, scale <span class="op">=</span> <span class="va">mean</span> <span class="op">/</span> <span class="va">shape</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">saveRDS</a></span><span class="op">(</span><span class="va">delay_dstns_byvar</span>, <span class="st">"delay-distns-byvar.rds"</span><span class="op">)</span></span></code></pre></div>
<p>We’ll use just the Serial Intervals (SI), though the incubation
periods (IP), and generation times (GT) are also available. Below, we
visualize the estimated delays for the 4 variants that were most
prevalent in Canada.</p>
<p><img src="delay-distributions_files/figure-html/variant-si-plot-1.png" width="80%" style="display: block; margin: auto;"></p>
<p>Finally, we use these delays during the period they were most
prevalent to estimate Rt. First, we build the delay matrix.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://Matrix.R-forge.R-project.org" class="external-link">Matrix</a></span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attaching package: 'Matrix'</span></span></code></pre>
<pre><code><span><span class="co">#&gt; The following objects are masked from 'package:tidyr':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     expand, pack, unpack</span></span></code></pre>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">cancovid</span><span class="op">)</span></span>
<span><span class="va">delay_mat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">n</span>, <span class="va">n</span><span class="op">)</span></span>
<span><span class="va">delay_mat</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">iter</span> <span class="kw">in</span> <span class="fl">2</span><span class="op">:</span><span class="va">n</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">current_var</span> <span class="op">&lt;-</span> <span class="va">can_pred_class</span><span class="op">$</span><span class="va">var</span><span class="op">[</span><span class="va">iter</span><span class="op">]</span></span>
<span>  <span class="va">current_pars</span> <span class="op">&lt;-</span> <span class="va">delay_dstns_can</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">type</span> <span class="op">==</span> <span class="va">current_var</span><span class="op">)</span></span>
<span>  <span class="va">delay</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/discretize_gamma.html">discretize_gamma</a></span><span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="op">(</span><span class="va">iter</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span>, <span class="va">current_pars</span><span class="op">$</span><span class="va">shape</span>, <span class="va">current_pars</span><span class="op">$</span><span class="va">scale</span><span class="op">)</span></span>
<span>  <span class="va">delay_mat</span><span class="op">[</span><span class="va">iter</span>, <span class="fl">1</span><span class="op">:</span><span class="va">iter</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rev.html" class="external-link">rev</a></span><span class="op">(</span><span class="va">delay</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">delay_mat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/drop0.html" class="external-link">drop0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/methods/as.html" class="external-link">as</a></span><span class="op">(</span><span class="va">delay_mat</span>, <span class="st">"CsparseMatrix"</span><span class="op">)</span><span class="op">)</span> <span class="co"># make it sparse, not necessary</span></span>
<span><span class="va">delay_mat</span> <span class="op">&lt;-</span> <span class="va">delay_mat</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/colSums-methods.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">delay_mat</span><span class="op">)</span> <span class="co"># renormalize</span></span></code></pre></div>
<p>Finally, we use this time-varying delay matrix to estimate Rt.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">can_tvar</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/estimate_rt.html">estimate_rt</a></span><span class="op">(</span></span>
<span>  <span class="va">cancovid</span><span class="op">$</span><span class="va">incident_cases</span>, </span>
<span>  x <span class="op">=</span> <span class="va">cancovid</span><span class="op">$</span><span class="va">date</span>, </span>
<span>  delay_distn <span class="op">=</span> <span class="va">delay_mat</span>,</span>
<span>  nsol <span class="op">=</span> <span class="fl">20L</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">can_tvar</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_cartesian.html" class="external-link">coord_cartesian</a></span><span class="op">(</span>ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="delay-distributions_files/figure-html/tvar-Rt-1.png" width="80%" style="display: block; margin: auto;"></p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Daniel J. McDonald, Jiaping Liu, Zhenglun Cai.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.9.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
